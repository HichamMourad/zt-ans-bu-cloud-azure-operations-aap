= Lab Guide: Day-2 Operations with Azure Dynamic Inventory
:toc:
:toc-title: Table of Contents
:sectnums:
:icons: font

_A guide to understanding Day-2 cloud operations and automating common use cases for Microsoft Azure._

*Estimated time to complete: 15 minutes*

---

== Lab Overview

Welcome to the `Ansible Hybrid Cloud Automation - Cloud Operations` lab. In this guide, you will learn about a pre-configured Dynamic Inventory for Microsoft Azure and see how it uses tags to manage cloud resources.

---

== Task 1: Understanding Credentials

First, you will log in to the automation controller and examine the pre-configured credentials for this lab.

. **Navigate to the Automation Controller UI.**
+
Click on the **Automation Controller** tab at the top of your lab window.

. **Log in with the provided credentials.**
+
[cols="1,2a"]
|===
| Parameter | Value
| Username | `admin`
| Password | `ansible123!`
|===

. **Examine the pre-configured credentials.**
+
Credentials are used to authenticate to machines, inventory sources, and version control systems. In this lab, we use three different credentials:
+
* **RHEL on Azure:** An SSH key for the Red Hat Enterprise Linux host.
* **Windows on Azure:** Credentials for the Windows Server host.
* **azure_credential:** A Microsoft Azure credential for performing actions on the cloud, like creating a virtual network or stopping an instance.
+
To view them, navigate to **Resources** → **Credentials** in the left navigation menu.

NOTE: Credential keys are encrypted. Once entered into the automation controller, no one, including administrators, can view the sensitive values.

---

== Task 2: Synchronize the Azure Inventory

Next, you will synchronize the dynamic inventory to ensure the automation controller has the latest host information from Azure.

. **Navigate to the Inventories menu.**
+
In the left navigation menu, go to **Resources** → **Inventories**.

. **Select the Azure Inventory.**
+
Click on the inventory named `Azure Inventory`.

. **Synchronize the inventory source.**
+
Select the **Sources** tab and click the **Sync All** button. This will update the host list from Azure.

. **View the updated hosts.**
+
Wait for the synchronization job status to show **Successful**, then click on the **Hosts** tab to view the discovered Azure virtual machines.

---

== Task 3: Create a Job Template to Retrieve VM Information

Now, you will create a job template to run a playbook that gathers and displays information about your Azure virtual machines.

. **Navigate to the Templates page.**
+
In the left navigation menu, go to **Resources** → **Templates**.

. **Initiate the creation of a new job template.**
+
Click the blue **Add** button, then select **Add job template**.

. **Enter the job template details.**
+
Fill out the form with the following information:
+
[cols="1,1"]
|===
| Parameter | Value
| Name | `Retrieve virtual machine information`
| Inventory | `Demo Inventory`
| Project | `Cloud Visibility Project`
| Execution Environment | `Microsoft Azure Execution Environment`
| Playbook | `playbooks/retrieve_vms.yml`
| Credentials | `azure_credential`
|===
+
TIP: To select the `azure_credential`, you may need to first filter the *Credential Type* to `Microsoft Azure Resource Manager`.

. **Save and launch the job template.**
+
Scroll to the bottom, click **Save**, and then **Launch** the template.

. **Observe the output.**
+
The job output will display information retrieved from your Azure VMs.

NOTE: In a highly dynamic environment, the Azure inventory can change often. It's important to trigger an inventory synchronization before running jobs that rely on that inventory. We will address this in the next task.

---

== Task 4: Build a Workflow to Sync and Retrieve Information

To ensure you are always working with the latest inventory, you will create a workflow that first syncs the Azure inventory and then runs the job template to retrieve VM information.

. **Navigate to the Templates page and initiate workflow creation.**
+
Go to **Resources** → **Templates**, click the blue **Add** button, and select **Add workflow template**.

. **Enter the workflow details.**
+
[cols="1,1"]
|===
| Parameter | Value
| Name | `WORKFLOW - Retrieve virtual machines information`
|===
+
Click **Save**. The Workflow Visualizer will open.

. **Add the first node (Inventory Sync).**
+
Click the **START** button. In the *Add Node* dialog, configure the first step:
+
--
a. **Node Type:** Select `Inventory Source Sync`.
b. **Inventory Source:** Select `Azure Source`.
c. Click **Save**.
--
+
image::../assets/azure_source.png[Adding an inventory source sync node, opts="border"]

. **Add the second node (Job Template).**
+
Hover over the `Azure Source` node you just created and click the **+** icon to add the next step. Configure it as follows:
+
image::../assets/add_node_azure.png[Adding a second node to the workflow, opts="border"]
+
--
a. **Run type:** Ensure `On Success` is selected. Click **Next**.
b. **Node Type:** This should default to `Job Template`.
c. **Job Template:** Select `Retrieve virtual machine information`.
d. Click **Save**.
--

. **Save the workflow.**
+
In the top right corner of the Visualizer, click **Save**. Your completed workflow is now ready.
+
image::../assets/full_workflow_azure.png[Completed Azure information workflow, opts="border"]

. **Launch the workflow.**
+
Navigate back to the *Templates* page and launch the `WORKFLOW - Retrieve virtual machines information` template. You can click on each node in the visualizer to see the output for that specific step.

This workflow ensures your inventory is always up-to-date before you attempt to gather information from it.

---

== Next Steps

You have successfully completed this lab. Press the `Next` button in your lab environment to proceed to the next challenge.
